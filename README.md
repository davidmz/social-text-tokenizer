# social-text-tokenizer

Пакет для разбора текстов постов и комментариев. Он предназначен для текстов сайта freefeed.net, но может быть адаптирован и для на других сервисов.

## TL;DR

Как быстро начать парсить тексты:

```JavaScript
import {
  combine, withText,
  hashTags, emails, mentions, foreignMentions, links, arrows
} from 'social-text-tokenizer';

// Находит в тексте hashTags, emails, mentions, foreignMentions, links, arrows,
// объединяет результаты и заполняет промежутки токенами типа Text.
const parse = withText(combine(hashTags(), emails(), mentions(), foreignMentions(), links(), arrows()));

const tokens = parse(text);
```

## Подробности

### Токены и токенизаторы

Пакет экспортирует функции-токенизаторы. Токенизатор принимает текст и возвращает массив найденных в нём токенов — элементов, под поиск которых заточен данный токенизатор.

```TypeScript
interface Tokenizer {
  (text: string): Token[];
}
```

Токены представляют собой найденные в тексте объекты и являются наследниками класса Token:

```TypeScript
class Token {
  type: string;   // тип токена (совпадает с именем класса)
  offset: number; // позиция начала в строке
  text: string;   // текст токена без изменений
  …
}
```

Пакет экспортирует следующие токены (классы) и соответствующие конструкторы токенизаторов:

- Text — простой текст, используется для заполнения интервалов между значимыми токенами
- HashTag (и токенизатор _hashTags()_) — хэштег
- Email (и токенизатор _emails()_) — адрес e-mail
- Mention (и токенизатор _mentions()_) — @-упоминание логина пользователя
- ForeignMention (и токенизатор _foreignMentions()_) — упоминание пользователя другой соцсети вида username@service
- Link (и токенизаторы _links()_) — URL в тексте
- Arrows (и токенизатор _arrows()_) — ссылки на комментарии вида ^^ или ↑↑

Функции-конструктры токенизаторов возвращают токенизаторы нужного типа. Они имеют опциональные аргументы, позволяеющие уточнять,
какие именно токены будут захвачены. Каждый токенизатор возвращает токены своего типа.

#### Особенности токенов

Отдельные типы токенов имеют дополнительные свойства, расширяющий стандартный класс Token.

Классы Link и Email имеют дополнительное строковое поле _pretty_. Этом поле представляет ссылку или адрес e-mail
в виде, предназначеном для показа пользователю. В частности, IDN-домены в нём представлены в Unicode-виде, а все параметры
и элементы пути у ссылок URL-раскодированы.

Класс Link имеет дополнительное поле _href_, оно содержит абсолютный URL, пригодный для использования, например,
в href-атрибуте ссылки. В частности, _href_ всегда содержит URL-схему, даже если в исходном тексте её нет.

Класс Link имеет дополнительный метод _shorten(limit)_. Он возвращает pretty-вид ссылки, обрезанный так, чтобы быть
не длиннее limit символов.

### Объединение результатов

Функция _combine_ принимает токенизаторы-аргументы и возвращает токенизатор, который объединяет результаты аргументов:

```JavaScript
// Простые токенизаторы
const emailTokens = emails(text);
const linkTokens = links(text);

// Комбинированный токенизатор
const emailAndLinkTokens = combine(emails, links)(text);
```

Комбинированный токенизатор выдаёт только непересекающиеся токены. При конфликте токенов из разных источников выбирается токен, который начинается раньше или имеет большую длину.

### Добавление текстовых токенов

Функция _withText_ принимает токенизатор и возвращает новый токенизатор, который заполняет интервалы токенами типа Text.

```JavaScript
const tokens = hashTags("abc #def ghi");
// Result: [HashTag{offset: 4, text: "#def"}]

const tokensWithText = withText(hashTags)("abc #def ghi");
// Result: [
//  Text{offset: 0, text: "abc "},
//  HashTag{offset: 4, text: "#def"},
//  Text{offset: 8, text: " ghi"},
// ]
```

Текстовые токены имеет смысл добавлять на последнем этапе, после комбинирования токенизаторов.
